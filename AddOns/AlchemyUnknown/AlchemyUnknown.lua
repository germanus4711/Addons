local AlchemyUnknown = {
Name = "AlchemyUnknown",
Author = "Rhyono",
Version = "1.25"}

AlchemyUnknown.ReagentTable = {
["30164"]={[1]="crafting_alchemy_trait_restorehealth",[3]="crafting_alchemy_trait_restorestamina",[2]="crafting_alchemy_trait_restoremagicka",[4]="crafting_alchemy_trait_unstoppable"},
["77583"]={[1]="crafting_alchemy_trait_lowerspellresist",[3]="crafting_poison_trait_protection",[2]="crafting_alchemy_trait_increasearmor",[4]="crafting_poison_trait_increasehealing"},
["30148"]={[1]="crafting_alchemy_trait_ravagemagicka",[3]="crafting_alchemy_trait_restorehealth",[2]="crafting_alchemy_trait_lowerspellpower",[4]="crafting_alchemy_trait_invisible"},
["77590"]={[1]="crafting_alchemy_trait_ravagehealth",[3]="crafting_poison_trait_dot",[2]="crafting_poison_trait_protection",[4]="crafting_poison_trait_decreasehealing"},
["77591"]={[1]="crafting_alchemy_trait_increasespellresist",[3]="crafting_poison_trait_protection",[2]="crafting_alchemy_trait_increasearmor",[4]="crafting_poison_trait_decreasehealing"},
["77584"]={[1]="crafting_alchemy_trait_reducespeed",[3]="crafting_poison_trait_hot",[2]="crafting_alchemy_trait_invisible",[4]="crafting_poison_trait_decreasehealing"},
["77587"]={[1]="crafting_alchemy_trait_ravagestamina",[3]="crafting_poison_trait_dot",[2]="crafting_poison_trait_damage",[4]="crafting_poison_trait_increasehealing"},
["77585"]={[1]="crafting_alchemy_trait_restorehealth",[3]="crafting_poison_trait_hot",[2]="crafting_alchemy_trait_lowerspellcrit",[4]="crafting_poison_trait_increasehealing"},
["30152"]={[1]="crafting_alchemy_trait_lowerspellresist",[3]="crafting_alchemy_trait_increasespellpower",[2]="crafting_alchemy_trait_ravagehealth",[4]="crafting_alchemy_trait_ravagemagicka"},
["77589"]={[1]="crafting_alchemy_trait_ravagemagicka",[3]="crafting_poison_trait_damage",[2]="crafting_alchemy_trait_speed",[4]="crafting_poison_trait_hot"},
["30153"]={[1]="crafting_alchemy_trait_spellcrit",[3]="crafting_alchemy_trait_invisible",[2]="crafting_alchemy_trait_speed",[4]="crafting_alchemy_trait_unstoppable"},
["30149"]={[1]="crafting_alchemy_trait_lowerarmor",[3]="crafting_alchemy_trait_increaseweaponpower",[2]="crafting_alchemy_trait_ravagehealth",[4]="crafting_alchemy_trait_ravagestamina"},
["30151"]={[1]="crafting_alchemy_trait_ravagehealth",[3]="crafting_alchemy_trait_ravagestamina",[2]="crafting_alchemy_trait_ravagemagicka",[4]="crafting_alchemy_trait_stun"},
["30161"]={[1]="crafting_alchemy_trait_restoremagicka",[3]="crafting_alchemy_trait_ravagehealth",[2]="crafting_alchemy_trait_increasespellpower",[4]="crafting_alchemy_trait_detection"},
["30163"]={[1]="crafting_alchemy_trait_increasearmor",[3]="crafting_alchemy_trait_lowerweaponpower",[2]="crafting_alchemy_trait_restorehealth",[4]="crafting_alchemy_trait_restorestamina"},
["30162"]={[1]="crafting_alchemy_trait_increaseweaponpower",[3]="crafting_alchemy_trait_lowerarmor",[2]="crafting_alchemy_trait_restorestamina",[4]="crafting_alchemy_trait_weaponcrit"},
["77581"]={[1]="crafting_alchemy_trait_lowerarmor",[3]="crafting_alchemy_trait_detection",[2]="crafting_alchemy_trait_lowerweaponcrit",[4]="crafting_poison_trait_increasehealing"},
["30159"]={[1]="crafting_alchemy_trait_weaponcrit",[3]="crafting_alchemy_trait_detection",[2]="crafting_alchemy_trait_reducespeed",[4]="crafting_alchemy_trait_unstoppable"},
["30160"]={[1]="crafting_alchemy_trait_increasespellresist",[3]="crafting_alchemy_trait_lowerspellpower",[2]="crafting_alchemy_trait_restorehealth",[4]="crafting_alchemy_trait_restoremagicka"},
["30165"]={[1]="crafting_alchemy_trait_ravagehealth",[3]="crafting_alchemy_trait_lowerweaponcrit",[2]="crafting_alchemy_trait_lowerspellcrit",[4]="crafting_alchemy_trait_invisible"},
["30154"]={[1]="crafting_alchemy_trait_lowerspellpower",[3]="crafting_alchemy_trait_increasespellresist",[2]="crafting_alchemy_trait_ravagemagicka",[4]="crafting_alchemy_trait_detection"},
["30156"]={[1]="crafting_alchemy_trait_lowerweaponpower",[3]="crafting_alchemy_trait_increasearmor",[2]="crafting_alchemy_trait_ravagestamina",[4]="crafting_alchemy_trait_lowerweaponcrit"},
["30155"]={[1]="crafting_alchemy_trait_ravagestamina",[3]="crafting_alchemy_trait_restorehealth",[2]="crafting_alchemy_trait_lowerweaponpower",[4]="crafting_alchemy_trait_reducespeed"},
["30157"]={[1]="crafting_alchemy_trait_restorestamina",[3]="crafting_alchemy_trait_ravagehealth",[2]="crafting_alchemy_trait_increaseweaponpower",[4]="crafting_alchemy_trait_speed"},
["30158"]={[1]="crafting_alchemy_trait_increasespellpower",[3]="crafting_alchemy_trait_lowerspellresist",[2]="crafting_alchemy_trait_restoremagicka",[4]="crafting_alchemy_trait_spellcrit"},
["30166"]={[1]="crafting_alchemy_trait_restorehealth",[3]="crafting_alchemy_trait_weaponcrit",[2]="crafting_alchemy_trait_spellcrit",[4]="crafting_alchemy_trait_stun"},
["139019"]={[1]="crafting_poison_trait_hot",[2]="crafting_alchemy_trait_speed",[3]="crafting_poison_trait_increasehealing",[4]="crafting_poison_trait_protection"},
["139020"]={[1]="crafting_alchemy_trait_increasespellresist",[2]="crafting_alchemy_trait_reducespeed",[3]="crafting_poison_trait_damage",[4]="crafting_poison_trait_decreasehealing"},
["150789"]={[1]="crafting_alchemy_trait_heroism",[2]="crafting_poison_trait_damage",[3]="crafting_alchemy_trait_invisible",[4]="crafting_poison_trait_increasehealing"},
["150731"]={[1]="crafting_poison_trait_hot",[2]="crafting_alchemy_trait_restorestamina",[3]="crafting_alchemy_trait_heroism",[4]="crafting_poison_trait_decreasehealing"}
}

local function OnStation(eventCode,craftSkill)
	if craftSkill == CRAFTING_TYPE_ALCHEMY then
		EVENT_MANAGER:RegisterForUpdate(AlchemyUnknown.Name, 100, function() AlchemyUnknown.ShowIcons() end)
	end	
end

local function LeaveStation(eventCode,craftSkill)
	if craftSkill == CRAFTING_TYPE_ALCHEMY then
		EVENT_MANAGER:UnregisterForUpdate(AlchemyUnknown.Name)
	end
end

function AlchemyUnknown.ShowIcons()
	for index, data in pairs(ALCHEMY.inventory.list.activeControls) do
		--Ensure reagent
		if data["dataEntry"]["typeId"] == 2 then
			--Find id to update the correct item
			local _,_,_,item_id = ZO_LinkHandler_ParseLink(GetItemLink(data["dataEntry"]["data"]["bagId"],data["dataEntry"]["data"]["slotIndex"]))
			if AlchemyUnknown.ReagentTable[item_id] ~= nil then
				for icon = 1, 4, 1 do
					--Skip for known traits
					if data["traits"][icon].icon:IsHidden() then
						data["traits"][icon].icon:SetTexture('/esoui/art/icons/alchemy/' .. AlchemyUnknown.ReagentTable[item_id][icon] .. '.dds')
						data["traits"][icon].icon:SetDimensions(32,32)
						data["traits"][icon].icon:SetHidden(false)
					end
				end
			end
		end
	end
	for index, data in pairs(ALCHEMY.reagentSlots) do
		--Find id to update the correct item
		if #data["items"] ~= 0 then
			local _,_,_,item_id = ZO_LinkHandler_ParseLink(GetItemLink(data["items"][1]["bagId"],data["items"][1]["slotIndex"]))
			if AlchemyUnknown.ReagentTable[item_id] ~= nil then
				for icon = 1, 4, 1 do
					--Only fill empty slots
					if data["control"]:GetChild(icon+4):GetTextureFileName() == '' then
						data["control"]:GetChild(icon+4):SetTexture('/esoui/art/icons/alchemy/' .. AlchemyUnknown.ReagentTable[item_id][icon] .. '.dds')
						data["control"]:GetChild(icon+4):SetAlpha(1)
					end	
				end
			end
		end
	end	
end

local function OnAddOnLoaded(event, addonName)
	if addonName == AlchemyUnknown.Name then 
		EVENT_MANAGER:RegisterForEvent(AlchemyUnknown.Name, EVENT_CRAFTING_STATION_INTERACT, OnStation)
		EVENT_MANAGER:RegisterForEvent(AlchemyUnknown.Name, EVENT_END_CRAFTING_STATION_INTERACT, LeaveStation)
	end
end

EVENT_MANAGER:RegisterForEvent(AlchemyUnknown.Name, EVENT_ADD_ON_LOADED, OnAddOnLoaded)